#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Setup PATH for WSL environment
export PATH="/mnt/c/Program Files/nodejs:$PATH"
export PATH="/mnt/c/Users/Danil/AppData/Roaming/npm:$PATH"

# Check if Node.js and pnpm are available
if ! command -v node >/dev/null 2>&1; then
    echo "❌ Error: Node.js not found in PATH"
    echo "Current PATH: $PATH"
    exit 1
fi

if ! command -v pnpm >/dev/null 2>&1; then
    echo "❌ Error: pnpm not found in PATH"
    echo "Current PATH: $PATH"
    exit 1
fi

echo "✅ Node.js version: $(node --version)"
echo "✅ pnpm version: $(pnpm --version)"

WEBAPP="pt-web/"
GENERAL="pt-general/"

# generateSwaggerDocs () {
#   pnpm swag
# }

# generateDbSchemas () {
#   pnpm db:generate
# }

preventUncommitedChanges () {
  # Check for uncommitted changes
  git diff --exit-code
  if [ $? -ne 0 ]; then
    echo "Changes detected after running swag. Please add the generated files before committing."
    exit 1
  fi
}

runWebappIfChanged () {
  if git diff --name-only --cached | grep "$WEBAPP"
  then
    echo "webapp changed. checking..."
    pnpm web:lint-staged
    pnpm concurrently \
        "pnpm web:type-check" \
        "pnpm web:test" \
        "pnpm web:build-storybook" \
        "pnpm web:cypress:component:run"
  fi
}

runGeneralIfChanged () {
  if git diff --name-only --cached | grep "$GENERAL"
  then
    echo "general changed. checking..."
    pnpm general:lint-staged
    pnpm concurrently \
        "pnpm general:type-check" \
        "pnpm general:test" \
        "pnpm general:build"
  fi
}

# generateSwaggerDocs
# generateDbSchemas

preventUncommitedChanges

# integration and module tests
runWebappIfChanged
