import fs from "fs";
import path from "path";
import process from "process";
import swaggerJsdoc from "swagger-jsdoc";

const __dirname = process.env.PWD || process.cwd();

// Swagger configuration
const swaggerOptions = {
  definition: {
    openapi: "3.0.0",
    info: {
      title: "Photo Tours API",
      version: "1.0.0",
      description: "Backend API for Photo Tours application.",
      license: {
        name: "MIT",
        url: "https://opensource.org/licenses/MIT",
      },
    },
    servers: [
      {
        url: "http://localhost:3000",
        description: "Development server",
      },
    ],
  },
  apis: ["./src/server.ts"], // Path to the API docs
};

// Generate OpenAPI specification
const swaggerSpec = swaggerJsdoc(swaggerOptions);

// Create autogenerated directory if it doesn't exist
const docsDir = path.join(__dirname, "../autogenerated");
if (!fs.existsSync(docsDir)) {
  fs.mkdirSync(docsDir, { recursive: true });
}

// Write OpenAPI spec to JSON file
const specPath = path.join(docsDir, "openapi.json");
fs.writeFileSync(specPath, JSON.stringify(swaggerSpec, null, 2));

// Generate HTML documentation
const htmlTemplate = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Tours API Documentation</title>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5.27.0/swagger-ui.css" />
    <style>
        html { box-sizing: border-box; overflow: -moz-scrollbars-vertical; overflow-y: scroll; }
        *, *:before, *:after { box-sizing: inherit; }
        body { margin:0; background: #fafafa; }
    </style>
</head>
<body>
    <div id="swagger-ui"></div>
    <script src="https://unpkg.com/swagger-ui-dist@5.27.0/swagger-ui-bundle.js"></script>
    <script src="https://unpkg.com/swagger-ui-dist@5.27.0/swagger-ui-standalone-preset.js"></script>
    <script>
        window.onload = function() {
            const ui = SwaggerUIBundle({
                url: './openapi.json',
                dom_id: '#swagger-ui',
                deepLinking: true,
                presets: [
                    SwaggerUIBundle.presets.apis,
                    SwaggerUIStandalonePreset
                ],
                plugins: [
                    SwaggerUIBundle.plugins.DownloadUrl
                ],
                layout: 'StandaloneLayout'
            });
        };
    </script>
</body>
</html>
`;

const htmlPath = path.join(docsDir, "index.html");
fs.writeFileSync(htmlPath, htmlTemplate);

// console.log(' Documentation generated successfully!');
// console.log(` Files created:`);
// console.log(`   - ${specPath}`);
// console.log(`   - ${htmlPath}`);
// console.log(` Open pt-general/autogenerated/index.html in your browser to view the documentation`);
